<?xml version="1.0" encoding="UTF-8"?><script><script_id>25:WPDS</script_id><name>RunOnceLastReached-GRS</name><script_type_id>3</script_type_id><row_version>33</row_version><lu_id>SNEHAI</lu_id><lu_date>2015-10-27T00:57:21</lu_date><false_msg/><description/><emit_events>0</emit_events><script_line><script_line_id>210:TEST</script_line_id><script_id>25:WPDS</script_id><sequence>1</sequence><script_class_id>7</script_class_id><source_name>LOCAL</source_name><row_version>1</row_version><lu_id>SNEHAI</lu_id><lu_date>2015-10-27T00:57:21</lu_date><statement>importPackage(Packages.com.workpoint.common.data);[lf][lf]SymbolTable.add("colid", ThisJobData.getBulkUserDataString("OrderId"));[lf]// Need to use proc_node_template_id for the actid[lf]SymbolTable.add("nodeid", ThisJobNodeData.getProcessNodeTemplateID().getID());[lf]SymbolTable.add("nodedb",ThisJobNodeData.getProcessNodeTemplateID().getDB());[lf][lf]SymbolTable.add("actid",ThisActivityInstData.getActivityID().getID());[lf]SymbolTable.add("actdb",ThisActivityInstData.getActivityID().getDB());</statement><name/><validation_status>0</validation_status><validation_status_msg/></script_line><script_line><script_line_id>211:TEST</script_line_id><script_id>25:WPDS</script_id><sequence>2</sequence><script_class_id>1</script_class_id><source_name>LOCAL</source_name><row_version>1</row_version><lu_id>SNEHAI</lu_id><lu_date>2015-10-27T00:57:21</lu_date><statement>{call [lf]WP_RUN_ONCE_LAST_DELETE([lf]   :colid[char, input], :ProcInstID[char, input], :ProcInstDB[char, input], [lf]   :nodeid[char, input], :nodedb[char, input], :actid[char, input],[lf]   :actdb[char, input],:Result1[int,output]) [lf]}</statement><name/><validation_status>0</validation_status><validation_status_msg/></script_line><script_line><script_line_id>212:TEST</script_line_id><script_id>25:WPDS</script_id><sequence>3</sequence><script_class_id>7</script_class_id><source_name>LOCAL</source_name><row_version>1</row_version><lu_id>SNEHAI</lu_id><lu_date>2015-10-27T00:57:21</lu_date><statement>importPackage(Packages.com.workpoint.common.script);[lf]importPackage(Packages.com.workpoint.client);[lf]importPackage(Packages.com.workpoint.common.data);[lf]importPackage(Packages.com.workpoint.common.util);[lf][lf]importPackage(Packages.java.math);[lf]importPackage(Packages.java.lang);[lf]importPackage(Packages.java.util);[lf][lf]importPackage(Packages.com.csgsystems.fx.security);[lf]importPackage(Packages.com.csgsystems.bali.connection);[lf]importPackage(Packages.com.csgsystems.aruba.connection);[lf][lf][lf]// check if we run[lf]var run = SymbolTable.getSymbol("Result1").getPrimaryValue();[lf]try[lf]{[lf]  java.lang.System.out.println("Actid: " + SymbolTable.getSymbol("ActInstIDStr").getPrimaryValue() + "==" + run);[lf]  if (run == -1)[lf]  {[lf]     ThisJobData.setActivityBulkUserData(ThisActivityInstData.getActivityInstID(), "retry","true");[lf]     // complete activity [lf]      SymActID = SymbolTable.getSymbol("ActInstID").getPrimaryValue();[lf]      SymActDB = SymbolTable.getSymbol("ActInstDB").getPrimaryValue();[lf]      SymIteration = SymbolTable.getSymbol("WorkItemIteration").getPrimaryValue();[lf]      activity = new TableID(SymActID + ":" + SymActDB);[lf]      job = Job.queryByID(ClientContext, new TableID(SymbolTable.getSymbol("ProcInstIDStr").getPrimaryValue()), true);[lf]      work = WorkItemEntry.queryByID(ClientContext, activity, SymIteration);[lf][lf]      if( work != null )[lf]     {[lf]          workstate = work.getWorkStateID();[lf]          if( workstate == WorkItemConst.WORK_STATE_AVAILABLE ) // Available[lf]             work.open();[lf]         work.changeState(WorkItemConst.WORK_STATE_COMPLETE, 0, 52, "Need to rerun. Database locked");[lf]      }[lf]  }[lf]  else if( run &gt; 1 )[lf]  {[lf]    ThisJobData.setActivityBulkUserData(ThisActivityInstData.getActivityInstID(), "retry","false");[lf]    // complete activity [lf]    SymActID = SymbolTable.getSymbol("ActInstID").getPrimaryValue();[lf]    SymActDB = SymbolTable.getSymbol("ActInstDB").getPrimaryValue();[lf]    SymIteration = SymbolTable.getSymbol("WorkItemIteration").getPrimaryValue();[lf]    activity = new TableID(SymActID + ":" + SymActDB);[lf]    job = Job.queryByID(ClientContext, new TableID(SymbolTable.getSymbol("ProcInstIDStr").getPrimaryValue()), true);[lf]    work = WorkItemEntry.queryByID(ClientContext, activity, SymIteration);[lf][lf]    if( work != null )[lf]    {[lf]        workstate = work.getWorkStateID();[lf]        if( workstate == WorkItemConst.WORK_STATE_AVAILABLE ) // Available[lf]          work.open();[lf][lf]       work.changeState(WorkItemConst.WORK_STATE_COMPLETE, 0, 51, "Completed by system:  Another runonce node is running");[lf]    }[lf]  }[lf]   else[lf]  {[lf]     // run grs[lf]        ThisJobData.setActivityBulkUserData(ThisActivityInstData.getActivityInstID(), "retry","false");[lf][lf]        sm = SecurityManagerFactory.createSecurityManager ();[lf]        connfact = new ConnectionFactory();[lf]        conn =connfact.createConnection(BSDMSettings.getDefault ());[lf][lf]        resmap = new HashMap();[lf]        keymap = new HashMap();[lf][lf]        workItemIter = ThisWorkItemData.getWorkItemIteration();[lf]        keymap.put("WorkItemId", SymbolTable.getSymbol("ActInstIDStr").getPrimaryValue());[lf]        keymap.put("Iteration", new Integer(workItemIter)); [lf][lf]        resmap.put("APIName", "WorkpointUpdate");[lf]        serverid = new Integer(ThisJobData.getBulkUserDataString("CustomerServerId"));[lf]        resmap.put("CustomerServerId",serverid);[lf]        resmap.put("Key", keymap);[lf][lf]        reqestmap = new HashMap();[lf]        reqestmap.put("ResponseAPI", resmap);[lf][lf]        session = BSDMSessionContext.getDefaultContext()[lf]        session.setSecurityContext(sm);[lf]        session.setServerId(serverid);[lf][lf]        // Add actionid[lf]        reqestmap.put("ActionId", new Integer(ThisJobData.getActivityBulkUserDataString(ThisActivityInstData.getActivityInstID(),"ActionId")));[lf]        //reqestmap.put("ServiceOrderId", ThisJobData.getBulkUserDataString("ServiceOrderId"));[lf]        reqestmap.put("ServiceOrderId", new BigInteger(ThisJobData.getBulkUserDataString("ServiceOrderId")));[lf] [lf]        java.lang.System.out.println("Running GRS for: Job: " + SymbolTable.getSymbol("ProcInstIDStr").getPrimaryValue() + " Act: " + SymbolTable.getSymbol("ActInstIDStr").getPrimaryValue());[lf]        reqestmap = conn.call(session, ApiMappings.getCallName ("PerformAction"), reqestmap); [lf]   }[lf]}[lf]catch(e)[lf]{[lf]      java.lang.System.out.println("exception: " + e);[lf]        // need to complete node with code[lf]  [lf]     SymIteration = SymbolTable.getSymbol("WorkItemIteration").getPrimaryValue();[lf]     activity = new TableID(SymbolTable.getSymbol("ActInstIDStr").getPrimaryValue());[lf]     work = WorkItemEntry.queryByID(ClientContext, activity, SymIteration);[lf][lf]     ThisJobData.setActivityBulkUserData(ThisActivityInstData.getActivityInstID(), "retry","false");[lf][lf]     if( work != null )[lf]    {[lf]       workstate = work.getWorkStateID();[lf]       if( workstate == WorkItemConst.WORK_STATE_AVAILABLE ) // Available[lf]          work.open();[lf][lf]       work.changeState(WorkItemConst.WORK_STATE_COMPLETE, 0, 60, "exception: " + e);[lf]    }[lf]}</statement><name/><validation_status>0</validation_status><validation_status_msg/></script_line><validation_status>0</validation_status></script>