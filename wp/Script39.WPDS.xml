<?xml version="1.0" encoding="UTF-8"?><script><script_id>39:WPDS</script_id><name>GetPaymentId</name><script_type_id>3</script_type_id><row_version>153</row_version><lu_id>SNEHAI</lu_id><lu_date>2015-10-27T00:57:33</lu_date><false_msg/><description/><emit_events>0</emit_events><script_line><script_line_id>119:TEST</script_line_id><script_id>39:WPDS</script_id><sequence>1</sequence><script_class_id>7</script_class_id><source_name>LOCAL</source_name><row_version>1</row_version><lu_id>SNEHAI</lu_id><lu_date>2015-10-27T00:57:33</lu_date><statement>importPackage(Packages.com.csgsystems.aruba.connection);[lf]importPackage(Packages.com.csgsystems.aruba.filter);[lf]importPackage(Packages.com.csgsystems.bp.data);[lf]importPackage(Packages.com.csgsystems.bp.session);[lf]importPackage(Packages.com.csgsystems.fx.security);[lf]importPackage(Packages.com.csgsystems.aruba.filter);[lf]importPackage(Packages.com.csgsystems.om.session);[lf]importPackage(Packages.com.csgsystems.om.data);[lf]importPackage(Packages.java.lang);[lf]importPackage(Packages.java.math);[lf]importPackage(Packages.com.csgsystems.aruba.bp.session);[lf]importPackage(Packages.com.workpoint.client);[lf]importPackage(Packages.com.workpoint.common.util);[lf]importPackage(Packages.com.workpoint.common.data);[lf][lf]importPackage(Packages.com.workpoint.common.logging);[lf][lf]try[lf]{[lf]   logger = WPLogger.getLogger("com.workpoint.comverse.getPaymentId");[lf]   logger.debug("DEBUG:  inside getPaymentId");[tab][tab][lf][tab][lf]   // Check to see if this script is ran in a subjob[lf]   if (ThisJobData.getJobParentID())[lf]  {[lf]     logger.debug("DEBUG: gettingparent job");[lf]     job = Job.queryByID(ClientContext, ThisJobData.getJobParentID(), true);[lf]     soid =job.getBulkUserDataString("ServiceOrderId");[lf]     oid = job.getBulkUserDataString("OrderId");[lf]     serverid = new Integer(job.getBulkUserDataString("CustomerServerId"));[lf]   }[lf]   else[lf]   {[lf]      logger.debug("DEBUG: no parent");[lf]      soid = ThisJobData.getBulkUserDataString("ServiceOrderId");[lf]      oid = ThisJobData.getBulkUserDataString("OrderId");[lf]      serverid = new Integer(ThisJobData.getBulkUserDataString("CustomerServerId"));[lf]    }[lf]   jobnodeid = ThisJobNodeData.getJobNodeID();     [lf]   activityInst = ThisJobData.getActivityByNodeID(jobnodeid);[lf]   actid = activityInst.getActivityInstID();[lf][lf]    sm = SecurityManagerFactory.createSecurityManager ();[lf]    bean = new ItemBean(BSDMSettings.getDefault());[lf]    filter = new ItemObjectFilter();[lf][lf]    mtyidfilter = new Array(1);[lf]    mtyidfilter[0]=new IntegerEquals(new Integer(ThisJobData.getActivityBulkUserDataString(actid,"MemberType")));[lf]    filter.setMemberTypeFilter(mtyidfilter);[lf][lf]    itemactfilter=new Array(1);[lf]    itemactfilter[0]=new IntegerEquals(new Integer(ThisJobData.getActivityBulkUserDataString(actid,"ItemActionId")));[lf]    filter.setItemActionIdFilter(itemactfilter);[lf][lf]    soarryfilter= new Array(1);[lf]    soarryfilter[0]=new BigIntegerEquals(new BigInteger(soid));[lf]    filter.setServiceOrderIdFilter(soarryfilter);[lf][lf]    context = BSDMSessionContext.getDefaultContext();[lf]    context.setSecurityContext (sm);[lf]    context.setServerId(serverid);[lf]    [lf]    // set Fetch for the whole object[lf]    fetchAll = true ;[lf]    filter.setFetch(fetchAll);[lf]     [lf]    found = bean.find(context, filter);[lf]  [lf]    if (found.getLength() == 0)[lf]        logger.debug("Debug: GetPaymentId:  Not found. ");       [lf]        // need to complete node with code We should never get here[lf][lf]        SymIteration = SymbolTable.getSymbol("WorkItemIteration").getPrimaryValue();[lf]        activity = new TableID(SymbolTable.getSymbol("ActInstIDStr").getPrimaryValue());[lf]        work = WorkItemEntry.queryByID(ClientContext, activity, SymIteration);[lf][lf]        if( work != null )[lf]       {[lf]         workstate = work.getWorkStateID();[lf]         if( workstate == WorkItemConst.WORK_STATE_AVAILABLE ) // Available[lf]           work.open();[lf]         work.changeState(WorkItemConst.WORK_STATE_COMPLETE, 0, 60, "Payment Order Item not found ");[lf]       }[lf]       else {[lf]          logger.debug("Debug: GetPaymentId: found. ");    [lf]          itemObjectDataArr =  found.getArray();[lf]          logger.debug("Inside getPaymentId itemObjectDataArr.length:"+itemObjectDataArr.length); [lf][lf]          paymentBean = new PaymentBean(BSDMSettings.getDefault());[lf]          logger.debug("Inside getPaymentId  PaymentBean IS CREATED......"); [lf][lf]          i=0 ;[lf]          while ( i &lt; itemObjectDataArr.length ) {[lf]                memberInstId = new Integer(itemObjectDataArr[i].getMemberInstId());[lf]                logger.debug("Inside getPaymentId memberInstId as Integer:"+memberInstId.toString());               [lf]                memberInstId2 = new Integer(itemObjectDataArr[i].getMemberInstId2());[lf]                logger.debug("Inside getPaymentId memberInstId2 as Integer:"+memberInstId2.toString());[lf]            [lf]                paymentBean.completePending(context,memberInstId,memberInstId2);[lf]                logger.debug("Inside getPaymentId after paymentBean.completePending... ");[lf] [lf]                i = i + 1;[lf]          } //while  [lf]          // Complete the workitem[lf]          SymIteration = SymbolTable.getSymbol("WorkItemIteration").getPrimaryValue();[lf]          activity = new TableID(SymbolTable.getSymbol("ActInstIDStr").getPrimaryValue());[lf]          work = WorkItemEntry.queryByID(ClientContext, activity, SymIteration);[lf]          if( work != null )[lf]         {[lf]           workstate = work.getWorkStateID();[lf]           logger.debug("DEBUG: workstate: " + workstate);[lf]           if( workstate == WorkItemConst.WORK_STATE_AVAILABLE ) // Available[lf]          {[lf]             logger.debug("DEBUG: workstate calling work.openAndComplete");[lf]             work.openAndComplete(0);[lf]          }[lf]          else if( workstate == WorkItemConst.WORK_STATE_OPEN ) // Open[lf]         {[lf]             logger.debug("DEBUG: calling work.complete ");[lf]             work.complete(0);[lf]          } [lf]        }[lf]      }[lf]} //try[lf]catch(e)[lf]{[lf]   java.lang.System.out.println("exception: " + e);[lf]   // need to complete node with code[lf]  [lf]  SymIteration = SymbolTable.getSymbol("WorkItemIteration").getPrimaryValue();[lf]  activity = new TableID(SymbolTable.getSymbol("ActInstIDStr").getPrimaryValue());[lf]  work = WorkItemEntry.queryByID(ClientContext, activity, SymIteration);[lf][lf]  if( work != null )[lf] {[lf]    workstate = work.getWorkStateID();[lf]    if( workstate == WorkItemConst.WORK_STATE_AVAILABLE ) // Available[lf]      work.open();[lf][lf]    work.changeState(WorkItemConst.WORK_STATE_COMPLETE, 0, 60, "exception: " + e);[lf]  }[lf]}</statement><name/><validation_status>0</validation_status><validation_status_msg/></script_line><validation_status>0</validation_status></script>